/**
 * 내격(內格) 판단 로직
 * 
 * 특수격이 아닌 경우, 월지(月支)를 기준으로 격국 판단
 * - 왕지(자오묘유): 가장 단순
 * - 생지(인신사해): 중간 난이도
 * - 고지(진술축미): 가장 복잡
 */

import type { SajuInfo, Ohaeng, GeokgukResult } from '../types';
import {
  get일간,
  get월지,
  get천간4글자,
  get지지4글자,
  getOhaengOfGan,
  check투출,
  determine격명칭,
  detect삼합,
  detect방합,
} from './gyeokguk';
import {
  wangjiJijanggan,
  saengjiJijanggan,
  gojiJijanggan,
  classifyWolji,
} from './geokguk-data';

// ============================================
// 1. 왕지(자오묘유) 격국 판단
// ============================================

/**
 * 왕지 격국 판단
 * 가장 단순: 본기가 그대로 격
 */
export function judgeWangjiGeokguk(sajuInfo: SajuInfo): GeokgukResult {
  const 일간 = get일간(sajuInfo);
  const 월지 = get월지(sajuInfo);
  const 천간4글자 = get천간4글자(sajuInfo);

  const 지장간 = wangjiJijanggan[월지];
  if (!지장간) {
    return {
      판단가능: false,
      메시지: '월지 분류 오류',
      이유: ['월지가 왕지에 속하지 않습니다'],
    };
  }

  const 본기 = 지장간.본기.char;
  const 투출여부 = check투출(본기, 천간4글자);
  const 격명칭 = determine격명칭(일간, 본기, 월지);

  return {
    판단가능: true,
    격국: {
      격명칭,
      격용신: 본기,
      격분류: '내격',
      월지,
      성격상태: 투출여부 ? '성격' : '파격',
      강도: '강',
      신뢰도: 투출여부 ? 95 : 80,
      판단근거: {
        방법: '왕지_본기',
        투출천간: 투출여부 ? [본기] : [],
      },
      해석: `${월지}월은 ${본기}의 왕지입니다. 본기가 그대로 격이 되어 ${격명칭}이 성립합니다.${투출여부 ? '' : ' 다만 투출되지 않아 격국이 완전하지 않습니다.'}`,
    },
  };
}

// ============================================
// 2. 생지(인신사해) 격국 판단
// ============================================

/**
 * 생지 격국 판단
 * 투출 우선순위: 본기 > 중기 > 여기(사월만 인정)
 */
export function judgeSaengjiGeokguk(sajuInfo: SajuInfo): GeokgukResult {
  const 일간 = get일간(sajuInfo);
  const 월지 = get월지(sajuInfo);
  const 천간4글자 = get천간4글자(sajuInfo);

  const 지장간 = saengjiJijanggan[월지];
  if (!지장간) {
    return {
      판단가능: false,
      메시지: '월지 분류 오류',
      이유: ['월지가 생지에 속하지 않습니다'],
    };
  }

  // Step 1: 본기가 투출했는가?
  if (check투출(지장간.본기.char, 천간4글자)) {
    const 격명칭 = determine격명칭(일간, 지장간.본기.char, 월지);
    return {
      판단가능: true,
      격국: {
        격명칭,
        격용신: 지장간.본기.char,
        격분류: '내격',
        월지,
        성격상태: '성격',
        강도: '강',
        신뢰도: 95,
        판단근거: {
          방법: '생지_본기투출',
          투출천간: [지장간.본기.char],
        },
        해석: `${월지}월의 본기 ${지장간.본기.char}이 투출하여 ${격명칭}이 성립합니다.`,
      },
    };
  }

  // Step 2: 중기가 투출했는가?
  if (지장간.중기 && check투출(지장간.중기.char, 천간4글자)) {
    const 격명칭 = determine격명칭(일간, 지장간.중기.char, 월지);
    return {
      판단가능: true,
      격국: {
        격명칭,
        격용신: 지장간.중기.char,
        격분류: '내격',
        월지,
        성격상태: '성격',
        강도: '중',
        신뢰도: 85,
        판단근거: {
          방법: '생지_중기투출',
          투출천간: [지장간.중기.char],
        },
        해석: `${월지}월의 중기 ${지장간.중기.char}이 투출하여 ${격명칭}이 성립합니다.`,
      },
    };
  }

  // Step 3: 여기(무토)가 투출했는가? (사월만 인정!)
  if (지장간.여기 && check투출(지장간.여기.char, 천간4글자)) {
    if (월지 === '巳') {
      // 사월만 무토 인정 (화토동법)
      const 격명칭 = determine격명칭(일간, 지장간.여기.char, 월지);
      return {
        판단가능: true,
        격국: {
          격명칭,
          격용신: 지장간.여기.char,
          격분류: '내격',
          월지,
          성격상태: '성격',
          강도: '중',
          신뢰도: 80,
          판단근거: {
            방법: '생지_여기투출_사월특례',
            투출천간: [지장간.여기.char],
            일간체크: '사월 화토동법으로 무토 인정',
          },
          해석: `${월지}월의 여기 ${지장간.여기.char}이 투출하였고, 사월이므로 화토동법으로 무토의 힘이 인정되어 ${격명칭}이 성립합니다.`,
        },
      };
    }
    // 인월, 신월, 해월: 무토 불인정 → 본기로 이동
  }

  // Step 4: 아무것도 투출 안됨
  // 생지는 기운이 강하므로 본기를 격으로 사용
  const 격명칭 = determine격명칭(일간, 지장간.본기.char, 월지);
  return {
    판단가능: true,
    격국: {
      격명칭,
      격용신: 지장간.본기.char,
      격분류: '내격',
      월지,
      성격상태: '파격',
      강도: '중',
      신뢰도: 70,
      판단근거: {
        방법: '생지_본기미투출',
        투출천간: [],
      },
      해석: `${월지}월의 지장간이 투출하지 않았으나, 생지는 기운이 강하므로 본기 ${지장간.본기.char}을 격으로 사용합니다. 다만 투출되지 않아 격국이 완전하지 않습니다.`,
    },
  };
}

// ============================================
// 3. 고지(진술축미) 격국 판단 - 가장 복잡!
// ============================================

/**
 * 고지 격국 판단
 * 
 * 우선순위:
 * 0. 삼합/방합 확인 (최우선!)
 * 1. 본기(토) 투출 + 일간 체크
 * 2. 여기/중기 투출 확인
 * 3. 투출 간 경합 해결
 * 4. 미투출 예외 처리
 */
export function judgeGojiGeokguk(sajuInfo: SajuInfo): GeokgukResult {
  const 일간 = get일간(sajuInfo);
  const 월지 = get월지(sajuInfo);
  const 천간4글자 = get천간4글자(sajuInfo);
  const 지지4글자 = get지지4글자(sajuInfo);

  const 지장간 = gojiJijanggan[월지];
  if (!지장간) {
    return {
      판단가능: false,
      메시지: '월지 분류 오류',
      이유: ['월지가 고지에 속하지 않습니다'],
    };
  }

  const 일간오행 = getOhaengOfGan(일간);

  // ============================================
  // Step 0: 삼합/방합 확인 (최우선!)
  // ============================================
  const 삼합결과 = detect삼합(지지4글자);
  const 방합결과 = detect방합(지지4글자);

  if (삼합결과.성립 || 방합결과.성립) {
    const 합국결과 = 삼합결과.성립 ? 삼합결과 : 방합결과;
    const 합화오행 = 합국결과.오행;

    if (!합화오행) {
      return {
        판단가능: false,
        메시지: '합국 오류',
        이유: ['합화 오행을 확인할 수 없습니다'],
      };
    }

    // 합화된 오행이 천간에 투출했는가?
    const 합화투출 = 천간4글자.some(간 => getOhaengOfGan(간) === 합화오행);
    const 합화천간 = 합화투출 
      ? 천간4글자.find(간 => getOhaengOfGan(간) === 합화오행) || ''
      : '';

    // 합화 오행의 십성 계산을 위한 천간
    // 투출된 경우 그 천간 사용, 아니면 대표 천간 사용
    const 격용신천간 = 합화투출 && 합화천간 
      ? 합화천간 
      : (합화오행 === 'wood' ? '甲' :
         합화오행 === 'fire' ? '丙' :
         합화오행 === 'earth' ? '戊' :
         합화오행 === 'metal' ? '庚' : '壬');

    const 격명칭 = determine격명칭(일간, 격용신천간, 월지);

    return {
      판단가능: true,
      격국: {
        격명칭,
        격용신: 격용신천간,
        격분류: '내격',
        월지,
        성격상태: 합화투출 ? '성격' : '파격',
        강도: '강',
        신뢰도: 합화투출 ? 95 : 80,
        판단근거: {
          방법: '고지_합국',
          합국여부: 합국결과.종류,
          투출천간: 합화투출 && 합화천간 ? [합화천간] : [],
        },
        해석: `${월지}월이지만 ${합국결과.종류}을 이루어 ${합화오행}의 세력이 지배합니다. ${합화투출 ? '합화된 오행이 투출하여 성격입니다.' : '다만 투출되지 않아 격국이 완전하지 않습니다.'}`,
      },
    };
  }

  // ============================================
  // Step 1: 본기(토) 투출 확인 & 일간 체크
  // ============================================
  if (check투출(지장간.본기.char, 천간4글자)) {
    if (일간오행 === 'earth') {
      // 일간이 토 → 본기는 비겁이므로 격으로 불가
      // Step 2로 넘어감
    } else {
      // 일간이 토가 아니면 → 토가 격!
      const 격명칭 = determine격명칭(일간, 지장간.본기.char, 월지);
      return {
        판단가능: true,
        격국: {
          격명칭,
          격용신: 지장간.본기.char,
          격분류: '내격',
          월지,
          성격상태: '성격',
          강도: '강',
          신뢰도: 95,
          판단근거: {
            방법: '고지_본기투출',
            투출천간: [지장간.본기.char],
            일간체크: '일간≠토',
          },
          해석: `${월지}월의 본기 ${지장간.본기.char}(토)가 투출하여 ${격명칭}이 성립합니다.`,
        },
      };
    }
  }

  // ============================================
  // Step 2: 여기/중기 투출 확인
  // ============================================
  const 여기투출 = 지장간.여기 && check투출(지장간.여기.char, 천간4글자);
  const 중기투출 = 지장간.중기 && check투출(지장간.중기.char, 천간4글자);

  // 여기만 투출
  if (여기투출 && !중기투출 && 지장간.여기) {
    const 격명칭 = determine격명칭(일간, 지장간.여기.char, 월지);
    return {
      판단가능: true,
      격국: {
        격명칭,
        격용신: 지장간.여기.char,
        격분류: '내격',
        월지,
        성격상태: '성격',
        강도: '중',
        신뢰도: 90,
        판단근거: {
          방법: '고지_여기투출',
          투출천간: [지장간.여기.char],
        },
        해석: `${월지}월의 여기 ${지장간.여기.char}이 투출하여 ${격명칭}이 성립합니다.`,
      },
    };
  }

  // 중기만 투출
  if (중기투출 && !여기투출 && 지장간.중기) {
    const 격명칭 = determine격명칭(일간, 지장간.중기.char, 월지);
    return {
      판단가능: true,
      격국: {
        격명칭,
        격용신: 지장간.중기.char,
        격분류: '내격',
        월지,
        성격상태: '성격',
        강도: '중',
        신뢰도: 85,
        판단근거: {
          방법: '고지_중기투출',
          투출천간: [지장간.중기.char],
        },
        해석: `${월지}월의 중기 ${지장간.중기.char}이 투출하여 ${격명칭}이 성립합니다.`,
      },
    };
  }

  // ============================================
  // Step 3: 둘 다 투출 (경합 해결)
  // ============================================
  if (여기투출 && 중기투출 && 지장간.여기 && 지장간.중기) {
    // 수량 비교
    const 여기수량 = 천간4글자.filter(x => x === 지장간.여기.char).length;
    const 중기수량 = 천간4글자.filter(x => x === 지장간.중기.char).length;

    if (여기수량 > 중기수량) {
      const 격명칭 = determine격명칭(일간, 지장간.여기.char, 월지);
      return {
        판단가능: true,
        격국: {
          격명칭,
          격용신: 지장간.여기.char,
          격분류: '내격',
          월지,
          성격상태: '성격',
          강도: '중',
          신뢰도: 90,
          판단근거: {
            방법: '고지_여기중기경합',
            투출천간: [지장간.여기.char, 지장간.중기.char],
            일간체크: `수량 승부: 여기${여기수량}개 > 중기${중기수량}개`,
          },
          해석: `${월지}월의 여기와 중기가 모두 투출하였으나, 수량상 여기 ${지장간.여기.char}이 우선하여 ${격명칭}이 성립합니다.`,
        },
      };
    }

    if (중기수량 > 여기수량) {
      const 격명칭 = determine격명칭(일간, 지장간.중기.char, 월지);
      return {
        판단가능: true,
        격국: {
          격명칭,
          격용신: 지장간.중기.char,
          격분류: '내격',
          월지,
          성격상태: '성격',
          강도: '중',
          신뢰도: 90,
          판단근거: {
            방법: '고지_여기중기경합',
            투출천간: [지장간.여기.char, 지장간.중기.char],
            일간체크: `수량 승부: 중기${중기수량}개 > 여기${여기수량}개`,
          },
          해석: `${월지}월의 여기와 중기가 모두 투출하였으나, 수량상 중기 ${지장간.중기.char}이 우선하여 ${격명칭}이 성립합니다.`,
        },
      };
    }

    // 수량 같음 → 사령일수 승부 (여기 9일 > 중기 3일)
    const 격명칭 = determine격명칭(일간, 지장간.여기.char, 월지);
    return {
      판단가능: true,
      격국: {
        격명칭,
        격용신: 지장간.여기.char,
        격분류: '내격',
        월지,
        성격상태: '성격',
        강도: '중',
        신뢰도: 90,
        판단근거: {
          방법: '고지_여기중기경합',
          투출천간: [지장간.여기.char, 지장간.중기.char],
          일간체크: `사령일수 승부: 여기${지장간.여기.days}일 > 중기${지장간.중기.days}일`,
        },
        해석: `${월지}월의 여기와 중기가 모두 투출하였으나, 사령일수상 여기 ${지장간.여기.char}(${지장간.여기.days}일)이 중기 ${지장간.중기.char}(${지장간.중기.days}일)보다 강하여 ${격명칭}이 성립합니다.`,
      },
    };
  }

  // ============================================
  // Step 4: 아무것도 투출 안됨
  // ============================================
  if (일간오행 === 'earth') {
    // 일간이 토인 경우: 격국 미정
    return {
      판단가능: false,
      메시지: '격국을 판단하기 어렵습니다',
      이유: [
        '본기(토)는 일간과 같아 비겁이므로 격으로 불가',
        '중기와 여기가 투출되지 않음',
      ],
    };
  } else {
    // 일간이 토가 아닌 경우: 본기(토)를 격으로 보되 미완성
    const 격명칭 = determine격명칭(일간, 지장간.본기.char, 월지);
    return {
      판단가능: true,
      격국: {
        격명칭,
        격용신: 지장간.본기.char,
        격분류: '내격',
        월지,
        성격상태: '파격',
        강도: '약',
        신뢰도: 60,
        판단근거: {
          방법: '고지_본기미투출',
          투출천간: [],
          일간체크: '일간≠토',
        },
        해석: `${월지}월의 지장간이 투출하지 않아 격국이 완전하지 않습니다. 본기 ${지장간.본기.char}(토)를 격으로 보되, 운에서 투출할 때 성격됩니다.`,
      },
    };
  }
}

// ============================================
// 4. 내격 통합 판단 함수
// ============================================

/**
 * 내격 판단 (월지 분류에 따라)
 */
export function judgeNaegyeokGeokguk(sajuInfo: SajuInfo): GeokgukResult {
  const 월지 = get월지(sajuInfo);
  const 월지분류 = classifyWolji(월지);

  switch (월지분류) {
    case '왕지':
      return judgeWangjiGeokguk(sajuInfo);
    case '생지':
      return judgeSaengjiGeokguk(sajuInfo);
    case '고지':
      return judgeGojiGeokguk(sajuInfo);
    default:
      return {
        판단가능: false,
        메시지: '월지 분류 오류',
        이유: ['월지가 12지지에 속하지 않습니다'],
      };
  }
}

